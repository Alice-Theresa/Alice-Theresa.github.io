<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    
    <title>Archives: 2020 | Hexo</title>
    <meta name="description" content="A minimal hexo theme."/>
    <meta name="keywords" content="hexo,theme,otakism,otaku"/>
    <meta name="HandheldFriendly" content="True"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="google-site-verification" content=""/>
    <meta name="baidu-site-verification" content=""/>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/archives/2020/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Theresa">
<meta name="twitter:card" content="summary">
    

    <!-- Favicon -->
    

    <!-- Font -->
    <link href="https://fonts.googleapis.com/css?family=Inconsolata|Roboto:300,400,700" rel="stylesheet">

    
<link rel="stylesheet" href="/style.css">

    <script>
      function setLoadingBarProgress(num) {
        document.getElementById('loading-bar').style.width = num + "%";
      }
    </script>

    
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.1.0"></head>

<body>

<div id="loading-bar-wrapper">
  <div id="loading-bar"></div>
</div>

<script>setLoadingBarProgress(20)</script>

<div id="site-wrapper">

    <header id="header">
    <div id="header-wrapper" class="clearfix">
        <a id="logo" href="/">
            <img src="/img/logo.png"/>
            <span id="site-desc">
                断舍离
            </span>
        </a>
        <button id="site-nav-switch">
            <span class="icon icon-menu"></span>
        </button>
    </div>
</header>
    <script>setLoadingBarProgress(40);</script>

    <main id="main" role="main">
        
    


  <section class="page-header archive">
    <h1>- <span>2020</span> -</h1>
  </section>




<section class="post-list">
  
    <article class="post ">

    
        <h2 class="title">
            <a href="/2020/09/17/2020/reactNativeRouter2/">
                React Native 简易路由 续
            </a>
        </h2>
    
    <time>
        Sep 17, 2020
    </time>
    <section class="content">
        <img src="/images/2020/reactNativeRouter2/cover.jpg">

<p>对简易路由进行升级，加入参数回传功能，同样的，将支持原生、RN之间的回传</p>
<h3><span id="重构">重构</span></h3><p>将Navigator单独抽离，新增构造方法，每一个页面都将拥有独自的navigator，screenID为唯一字符串</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">constructor</span>(screenID, moduleName) &#123;</span><br><span class="line">  <span class="built_in">this</span>.screenID = screenID</span><br><span class="line">  <span class="built_in">this</span>.moduleName = moduleName</span><br><span class="line">  <span class="built_in">this</span>.resultListeners = <span class="literal">undefined</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>异步的push方法</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">push = <span class="keyword">async</span> (component, options) =&gt; &#123;</span><br><span class="line">  NavigationBridge.push(component, options)</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="built_in">this</span>.waitResult()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>waitResult返回一个Promise，暂存并等待pop回来的时候调用</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">waitResult() &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> listener = <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">      resolve([<span class="string">&#x27;ok&#x27;</span>, data])</span><br><span class="line">      <span class="built_in">this</span>.resultListener = <span class="literal">undefined</span></span><br><span class="line">    &#125;</span><br><span class="line">    listener.cancel = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      resolve([<span class="string">&#x27;cancel&#x27;</span>, <span class="literal">null</span>])</span><br><span class="line">      <span class="built_in">this</span>.resultListener = <span class="literal">undefined</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.resultListener = listener</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>pop回来的时候根据结果来执行或取消</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">execute(data) &#123;</span><br><span class="line">  <span class="built_in">this</span>.resultListener(data)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">unmount = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">this</span>.resultListener.cancel()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为了实现参数回传，需要增加一个setResult的桥接方法，将数据写入页面所对应栈的Model</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">setResult(data) &#123;</span><br><span class="line">  NavigationBridge.setResult(data)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3><span id="监听回调通知">监听回调通知</span></h3><p>原生路由调用pop后将会把结果发送给RN，这里为每一个页面加入监听，根据screenID来找到需要回调结果的页面，result_type来判断用否有传值</p>
<p>另外将navigator注入，可直接从props中获取</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> withNavigator = <span class="function">(<span class="params">moduleName</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">WrappedComponent</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> component = <span class="function">(<span class="params">props, ref</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; screenID &#125; = props</span><br><span class="line">      <span class="keyword">const</span> navigator = <span class="keyword">new</span> Navigator(screenID, moduleName)</span><br><span class="line">      useEffect(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> subscription = EventEmitter.addListener(<span class="string">&#x27;NavigationEvent&#x27;</span>, <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (data[<span class="string">&#x27;screen_id&#x27;</span>] === screenID &amp;&amp; data[<span class="string">&#x27;event&#x27;</span>] === <span class="string">&#x27;component_result&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (data[<span class="string">&#x27;result_type&#x27;</span>] === <span class="string">&#x27;cancel&#x27;</span>) &#123;</span><br><span class="line">              navigator.unmount()</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              navigator.execute(data[<span class="string">&#x27;result_data&#x27;</span>])</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">          subscription.remove()</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;, [])</span><br><span class="line">      <span class="keyword">const</span> injected = &#123;</span><br><span class="line">        navigator</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">WrappedComponent</span> <span class="attr">ref</span>=<span class="string">&#123;ref&#125;</span> &#123;<span class="attr">...props</span>&#125; &#123;<span class="attr">...injected</span>&#125; /&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> React.forwardRef(component)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注册前调用</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> withComponent = withNavigator(appKey)(component)</span><br><span class="line">AppRegistry.registerComponent(appKey, <span class="function">() =&gt;</span> withComponent)</span><br></pre></td></tr></table></figure>

<h3><span id="页面栈">页面栈</span></h3><p>为UIViewController新增一个分类</p>
<p>每次新建页面的时候都会随机生成一个screenID，这里用iOS的NSUUID方法来生成</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">UIViewController</span> (<span class="title">ALC</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>, <span class="keyword">readonly</span>) <span class="built_in">NSString</span> *screenID;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)didReceiveResultData:(<span class="built_in">NSDictionary</span> *)data type:(<span class="keyword">nonnull</span> <span class="built_in">NSString</span> *)type;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<p>每个tab都有独立的栈，为ALCNavigationManager新增栈以及对应的方法</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) <span class="built_in">NSMutableDictionary</span>&lt;<span class="built_in">NSString</span> *, <span class="built_in">NSMutableArray</span> *&gt; *stacks;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)push:(<span class="built_in">UINavigationController</span> *)nav vc:(<span class="built_in">UIViewController</span> *)vc;</span><br><span class="line">- (<span class="keyword">void</span>)clear;</span><br></pre></td></tr></table></figure>

<p>其中栈的数据模型</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ALCStackModel</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *screenID;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSDictionary</span> *data;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithScreenID:(<span class="built_in">NSString</span> *)screenID;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<p>自定义UINavigationController，用didShowViewController监听页面的变化，将每一次变化的viewController入栈</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)navigationController:(<span class="built_in">UINavigationController</span> *)navigationController</span><br><span class="line">       didShowViewController:(<span class="built_in">UIViewController</span> *)viewController</span><br><span class="line">                    animated:(<span class="built_in">BOOL</span>)animated &#123;</span><br><span class="line">    [[ALCNavigationManager shared] push:navigationController vc:viewController];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果入栈的viewController其screenID在栈中不存在，为push操作，否则为pop</p>
<p>如果pop的时候栈顶没有设置数据，即为取消返回，否则传值</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)push:(<span class="built_in">UINavigationController</span> *)nav vc:(<span class="built_in">UIViewController</span> *)vc &#123;</span><br><span class="line">    ALCStackModel *model = [[ALCStackModel alloc] initWithScreenID:vc.screenID];</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *stack = [<span class="keyword">self</span>.stacks valueForKey:nav.screenID];</span><br><span class="line">    <span class="keyword">if</span> (![stack containsObject:model]) &#123;</span><br><span class="line">        [stack addObject:model];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (stack.count &gt; <span class="number">1</span>) &#123;</span><br><span class="line">       <span class="built_in">NSUInteger</span> index = [stack indexOfObject:model];</span><br><span class="line">       ALCStackModel *last = stack.lastObject;</span><br><span class="line">       [stack removeObjectsInRange:<span class="built_in">NSMakeRange</span>(index + <span class="number">1</span>, <span class="keyword">self</span>.stacks.count - <span class="number">1</span>)];</span><br><span class="line">       <span class="keyword">if</span> (last.data) &#123;</span><br><span class="line">           [vc didReceiveResultData:last.data type:<span class="string">@&quot;ok&quot;</span>];</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           [vc didReceiveResultData:@&#123;&#125; type:<span class="string">@&quot;cancel&quot;</span>];</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3><span id="使用">使用</span></h3><p><font size="4"><strong>从RN页返回传参，不管上一页是什么</strong></font></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">props.navigator.setResult(&#123; <span class="attr">rn_key</span>: <span class="string">&quot;rn_value&quot;</span> &#125;)</span><br><span class="line">props.navigator.pop()</span><br></pre></td></tr></table></figure>

<p><font size="4"><strong>从原生页返回传参，不管上一页是什么</strong></font></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="keyword">self</span> setResult:@&#123;<span class="string">@&quot;native_key&quot;</span>: <span class="string">@&quot;native_value&quot;</span>&#125;];</span><br><span class="line">[<span class="keyword">self</span>.navigationController popViewControllerAnimated:<span class="literal">YES</span>];</span><br></pre></td></tr></table></figure>

<p><font size="4"><strong>RN页获取结果</strong></font></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> resp = <span class="keyword">await</span> props.navigator.push(<span class="string">&#x27;Detail&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><font size="4"><strong>原生页获取结果</strong></font></p>
<p>重写方法</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)didReceiveResultData:(<span class="built_in">NSDictionary</span> *)data type:(<span class="keyword">nonnull</span> <span class="built_in">NSString</span> *)type</span><br></pre></td></tr></table></figure>


        

        
            <div class="tags">
                <a class="tag-none-link" href="/tags/React-Native/" rel="tag">React Native</a>
            </div>
        

    </section>
</article>
  
    <article class="post ">

    
        <h2 class="title">
            <a href="/2020/08/23/2020/reactNativeRouter/">
                React Native 简易路由
            </a>
        </h2>
    
    <time>
        Aug 23, 2020
    </time>
    <section class="content">
        <img src="/images/2020/reactNativeRouter/cover.jpg">

<p>React Native有两大路由框架，react-navigation和react-native-navigation<br>第三方的路由使用起来并没有什么大问题，但对于原生和 RN 页面混合开发的项目来说，并不太友好<br>因此面对高度复杂的场景，自定义一个的路由会是更好的选择</p>
<p>以iOS为例，定制一个简易的原生路由</p>
<p>将拥有以下功能:<br>push、pop、popToRoot、present、dismiss、switchTab</p>
<p>同时兼容原生以及RN页面之间的切换</p>
<h3><span id="react-native部分">React Native部分</span></h3><p>导航的桥接方法</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">Navigatior</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> push = <span class="function">(<span class="params">component, options</span>) =&gt;</span> &#123;</span><br><span class="line">    NavigationBridge.push(component, options)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> pop = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    NavigationBridge.pop()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> popToRoot = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    NavigationBridge.popToRoot()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> present = <span class="function">(<span class="params">component, options</span>) =&gt;</span> &#123;</span><br><span class="line">    NavigationBridge.present(component, options)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> dismiss = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    NavigationBridge.dismiss()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> switchTab = <span class="function">(<span class="params">index</span>) =&gt;</span> &#123;</span><br><span class="line">    NavigationBridge.switchTab(index)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于路由在原生端控制，因此项目中的所有页面都需要单独注册，且注册的同时需要将每个页面的样式配置记录下来</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> registerComponent = <span class="function">(<span class="params">appKey, component</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> options = component.navigationItem || &#123;&#125;</span><br><span class="line">  NavigationBridge.registerReactComponent(appKey, options)</span><br><span class="line">  AppRegistry.registerComponent(appKey, <span class="function">() =&gt;</span> component)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">registerComponent(<span class="string">&#x27;Home&#x27;</span>, Home)</span><br><span class="line">registerComponent(<span class="string">&#x27;Setting&#x27;</span>, Setting)</span><br><span class="line">registerComponent(<span class="string">&#x27;Detail&#x27;</span>, Detail)</span><br><span class="line">registerComponent(<span class="string">&#x27;Present&#x27;</span>, Present)</span><br></pre></td></tr></table></figure>

<p>React Native各页面中的样式在navigationItem中设定，如导航栏标题、是否隐藏导航栏等</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Detail.navigationItem = &#123;</span><br><span class="line">  title: <span class="string">&#x27;Detail&#x27;</span>,</span><br><span class="line">  hideNavigationBar: <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注册完毕后调用setRoot设置根页面，这里设定为2个TabBar， 各自拥有独立的Navigation</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">NavigationBridge.setRoot(&#123;</span><br><span class="line">  root: &#123;</span><br><span class="line">    tabs: &#123;</span><br><span class="line">      children: [</span><br><span class="line">        &#123;</span><br><span class="line">          component: <span class="string">&#x27;Home&#x27;</span>,</span><br><span class="line">          title: <span class="string">&#x27;主页&#x27;</span>,</span><br><span class="line">          icon: Image.resolveAssetSource(<span class="built_in">require</span>(<span class="string">&#x27;./src/image/Home.png&#x27;</span>))</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          component: <span class="string">&#x27;Setting&#x27;</span>,</span><br><span class="line">          title: <span class="string">&#x27;设置&#x27;</span>,</span><br><span class="line">          icon: Image.resolveAssetSource(<span class="built_in">require</span>(<span class="string">&#x27;./src/image/Profile.png&#x27;</span>))</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3><span id="原生部分">原生部分</span></h3><p>主要有以下4个类</p>
<ul>
<li>ALCNativeViewController</li>
<li>ALCReactViewController</li>
<li>ALCNavigationBridge</li>
<li>ALCNavigationManager</li>
</ul>
<p>ALCNativeViewController和ALCReactViewController继承UIViewController，用于创建原生、RN的页面。</p>
<p>ALCNavigationBridge实现具体桥接的方法，即registerReactComponent、setRoot、push、pop等。</p>
<p>ALCNavigationManager管理路由，这里包含两个字典，分别记录原生、RN的页面，同时提供注册、查找页面的方法。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ALCNavigationManager</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) RCTBridge *bridge;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) <span class="built_in">NSMutableDictionary</span> *nativeModules;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) <span class="built_in">NSMutableDictionary</span> *reactModules;</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">instancetype</span>)shared;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)registerNativeModule:(<span class="built_in">NSString</span> *)moduleName forController:(Class)clazz;</span><br><span class="line">- (<span class="built_in">BOOL</span>)hasNativeModule:(<span class="built_in">NSString</span> *)moduleName;</span><br><span class="line">- (Class)nativeModuleClassFromName:(<span class="built_in">NSString</span> *)moduleName;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)registerReactModule:(<span class="built_in">NSString</span> *)moduleName options:(<span class="built_in">NSDictionary</span> *)options;</span><br><span class="line">- (<span class="built_in">BOOL</span>)hasReactModuleForName:(<span class="built_in">NSString</span> *)moduleName;</span><br><span class="line">- (<span class="built_in">NSDictionary</span> *)reactModuleOptionsForKey:(<span class="built_in">NSString</span> *)moduleName;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">UIViewController</span> *)fetchViewController:(<span class="built_in">NSString</span> *)pageName params:(<span class="built_in">NSDictionary</span> *)params;</span><br><span class="line">- (<span class="built_in">UIImage</span> *)fetchImage:(<span class="built_in">NSDictionary</span> *)json;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<p>在路由跳转时，会查找该页面是否注册过，根据该页面是RN还是原生来创建对应的控制器</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">UIViewController</span> *)fetchViewController:(<span class="built_in">NSString</span> *)pageName params:(<span class="built_in">NSDictionary</span> * __<span class="keyword">nullable</span>)params &#123;</span><br><span class="line">    <span class="built_in">BOOL</span> hasNativeVC = [<span class="keyword">self</span> hasNativeModule:pageName];</span><br><span class="line">    <span class="built_in">UIViewController</span> *vc;</span><br><span class="line">    <span class="keyword">if</span> (hasNativeVC) &#123;</span><br><span class="line">        Class clazz = [<span class="keyword">self</span> nativeModuleClassFromName:pageName];</span><br><span class="line">        vc = [[clazz alloc] initWithModuleName:pageName props:params];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">NSDictionary</span> *options = [<span class="keyword">self</span> reactModuleOptionsForKey:pageName];</span><br><span class="line">        RCTRootView *rootView = [[RCTRootView alloc] initWithBridge:<span class="keyword">self</span>.bridge moduleName:pageName initialProperties:params];</span><br><span class="line">        vc = [[ALCReactViewController alloc] initWithModuleName:pageName options:options];</span><br><span class="line">        vc.view = rootView;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> vc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3><span id="使用">使用</span></h3><p>如果有原生页面，启动时需要在AppDelegate里注册，该原生页面需要继承ALCNativeViewController，路由将自动支持原生页面的导航，这里注册了一个名为NativeViewController的原生页面</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[ALCNavigationManager shared].bridge = [[RCTBridge alloc] initWithDelegate:<span class="keyword">self</span> launchOptions:launchOptions];</span><br><span class="line">[[ALCNavigationManager shared] registerNativeModule:<span class="string">@&quot;NativeViewController&quot;</span> forController:[ThisIsViewController <span class="keyword">class</span>]];</span><br></pre></td></tr></table></figure>

<p>和跳转RN页面一样，跳转原生时只需要传入原生页面的注册名字</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;Button</span><br><span class="line">  title=<span class="string">&quot;push native&quot;</span></span><br><span class="line">  onPress=&#123;<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    Navigatior.push(<span class="string">&#x27;NativeViewController&#x27;</span>)</span><br><span class="line">  &#125;&#125;</span><br><span class="line">/&gt;</span><br></pre></td></tr></table></figure>

<p>同样的，原生跳转RN，根据RN页面注册的名称来创建即可</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)goToDetail &#123;</span><br><span class="line">    <span class="built_in">UIViewController</span> *vc = [[ALCNavigationManager shared] fetchViewController:<span class="string">@&quot;Detail&quot;</span> params:<span class="literal">nil</span>];</span><br><span class="line">    [<span class="keyword">self</span>.navigationController pushViewController:vc animated:<span class="literal">YES</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


        

        
            <div class="tags">
                <a class="tag-none-link" href="/tags/React-Native/" rel="tag">React Native</a>
            </div>
        

    </section>
</article>
  
    <article class="post ">

    
        <h2 class="title">
            <a href="/2020/07/31/2020/silver2020/">
                2020，看涨铜和银
            </a>
        </h2>
    
    <time>
        Jul 31, 2020
    </time>
    <section class="content">
        <p><font color="red"><strong>本文仅代表我个人观点，不构成任何投资建议，据此操作，盈亏自负</strong></font></p>
<h3><span id="炼铜术师-中国">炼铜术师 —— 中国</span></h3><p>上游的铜矿产主要集中在智利和秘鲁等南美国家，而中游的精炼产能主要在中国，占全球冶炼产能的 60%以上，且冶炼产能仍持续扩张，可以说是地球上最强的炼铜大国。不仅在中游占据主要份额，连下游的主要消费需求也是中国，铜下游以电力、建筑为主要应用，另外家电、电子也占据一定份额。中国作为最大的精炼铜消费国，严重依赖海外进口的铜矿石资源。</p>
<p>铜价的走势与黄金有些类似，08年美联储开启QE模式，美元贬值使得大宗商品价格飙升，铜价在11年达到了顶峰，如今历史再度重演，海量的钞票将会再次推高铜价。</p>
<p>由于海外疫情持续蔓延，导致部分铜矿山产能下降，另一方面，中国大陆的疫情得到压制，经济活动逐步恢复，对铜的需求上升。</p>
<p>产能出清、需求快速恢复叠加美联储的无限印钞，2020年，铜价有望走出一波升势。</p>
<img src="/images/2020/silver2020/copper.png">

<h3><span id="卖银王国-墨西哥">卖银王国 —— 墨西哥</span></h3><p>墨西哥，全球第一大白银生产国兼第一大白银出口国，估计除了毒品，也就白银能让墨西哥人感到自豪。紧接其后的是秘鲁以及中国，三者白银产量占全球一半份额。世界十大银矿，墨西哥和秘鲁占了半壁江山，而国内的多为中小型银矿。与黄金不同，白银的工业属性占比较大，其中光伏以及电子工业的应用较为广泛。</p>
<p>自疫情发生以来，银矿产量下滑极为显著，其实各类矿产大家都差不多，均受到疫情的影响导致矿产能下降。供需失衡以及无限印钞，今年各类大宗商品如矿产、农作物，价格有望起飞。</p>
<p>从历史的数据来看，金银比大幅偏离均值后，会实现均值回归。截止2020年7月，伦敦金已突破2011年的历史高点，以目前的金价水平，白银将会补涨。</p>
<img src="/images/2020/silver2020/goldAndSilver.png">

<p>从技术的角度来看，白银经历了长达6年的大底，且月线颈线突破，有望走出一波行情。</p>
<img src="/images/2020/silver2020/silver.png">

<p>2008年的最低点与2011年的最高点，白银涨幅接近500%，今年3月，伴随着美股的暴跌，白银达到最低点后，至今已收复全部跌势并开始上行，白银能否历史重演，实现数倍的涨幅，我们拭目以待。</p>
<h3><span id="风险提示">风险提示</span></h3><p>贵金属过猛的上涨会导致其自身有避险资产变为风险资产，且白银长期被国际庄家控盘，更具风险性。</p>


        

        
            <div class="tags">
                <a class="tag-none-link" href="/tags/%E6%8A%95%E8%B5%84/" rel="tag">投资</a><a class="tag-none-link" href="/tags/%E6%9D%82%E8%B0%88/" rel="tag">杂谈</a>
            </div>
        

    </section>
</article>
  
    <article class="post ">

    
        <h2 class="title">
            <a href="/2020/06/29/2020/gold2020/">
                2020，黄金上看2020
            </a>
        </h2>
    
    <time>
        Jun 29, 2020
    </time>
    <section class="content">
        <p>*指伦敦金（现货），美元每盎司</p>
<p><font color="red"><strong>本文仅代表我个人观点，不构成任何投资建议，据此操作，盈亏自负</strong></font></p>
<h3><span id="历史正在重演">历史正在重演</span></h3><p>2007年金融危机爆发后，股市、黄金开启了下跌模式<br>2008年10月 黄金达到当年最低点681.75美元<br>2008年11月 美联储宣布开启QE </p>
<p>随后黄金一路上行<br>2011年9月 黄金达到了历史的高点1920.94美元</p>
<p>接下来的数年，黄金逐步回落并在低位徘徊</p>
<img src="/images/2020/gold2020/gold.png">

<p>2019年中开始，黄金价格持续攀升<br>同时全球各国央行大规模收购黄金</p>
<p>2020年1月 世界公共卫生事件爆发<br>2020年3月3日 美联储宣布降息50个基点<br>2020年3月15日 美联储再次宣布降息100个基点，利率直接打到0<br>2020年3月23日 美联储宣布开启无限QE<br>2020年6月 金价达到了2013年以来的新高</p>
<h3><span id="印钞一时爽一直印钞一直爽">印钞一时爽，一直印钞一直爽</span></h3><p>根据美联储的官方数据，08年开启QE后，用了近5年的时间，其资产负债表才从1万亿美元增加至4万亿美元，增幅为3万多亿<br>而今年3月开始，只用了短短的3个月时间，就把之前08到14年的路走完了，资产负债表直接增加了近3万亿<br>基于目前美国的状况来看，美联储的资产负债很可能在未来的一段时间继续上行</p>
<img src="/images/2020/gold2020/FRED.png">

<p>因此我们可以大胆的预测，金价将会在2020年突破2011年的高点并向2000美元冲刺</p>
<h3><span id="黄金买买买">黄金买买买</span></h3><p>在3、4月份期间，伦敦金（现货黄金）与纽约金（期货黄金）出现了长时间较大的正价差，即期货黄金比现货黄金高出数十美元，超过2%的价差，这意味着你可以买入现货黄金去卖出（交割）期货黄金来套利（除去运费仓储等费用）</p>
<p>而我们再看一下最近1年美国黄金进口的数据</p>
<img src="/images/2020/gold2020/import.png">

<p>可以看到4月份美国黄金进口数量激增<br>美国利用黄金差价这一金融游戏的规则，让全世界的人心甘情愿地将黄金送到美国去交割套利<br>连美国都在大量的进口黄金，或许他们也知道无限量的印钞会让美元变得一文不值，赶紧买些黄金来压压惊，可见未来黄金的地位将愈发重要</p>
<h3><span id="风险提示">风险提示</span></h3><p>极端抛售，世界疫情好转，美联储政策收紧等因素将会阻碍金价上行</p>


        

        
            <div class="tags">
                <a class="tag-none-link" href="/tags/%E6%8A%95%E8%B5%84/" rel="tag">投资</a><a class="tag-none-link" href="/tags/%E6%9D%82%E8%B0%88/" rel="tag">杂谈</a>
            </div>
        

    </section>
</article>
  
    <article class="post ">

    
        <h2 class="title">
            <a href="/2020/05/23/2020/bilateralFilter/">
                利用双边滤波处理图片
            </a>
        </h2>
    
    <time>
        May 23, 2020
    </time>
    <section class="content">
        <p>双边滤波其实和均值滤波、高斯滤波没有多大的区别  </p>
<p>它只是在这些滤波器的基础上对边缘区域进行加权处理，从而减少模糊对边缘的影响<br>对于非边缘区域，我们给滤波器一个较大的权重，以提高其模糊效果，在边缘区域则给一个较小的权重来保留细节</p>
<p>双边滤波公式</p>
<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathsize="1.44em"><msub><mi>I</mi><mi>D</mi></msub><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mrow><msub><mo>∑</mo><mrow><mi>k</mi><mo separator="true">,</mo><mi>l</mi></mrow></msub><mrow><mi>I</mi><mo stretchy="false">(</mo><mi>k</mi><mo separator="true">,</mo><mi>l</mi><mo stretchy="false">)</mo><mi>w</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo separator="true">,</mo><mi>k</mi><mo separator="true">,</mo><mi>l</mi><mo stretchy="false">)</mo></mrow></mrow><mrow><msub><mo>∑</mo><mrow><mi>k</mi><mo separator="true">,</mo><mi>l</mi></mrow></msub><mrow><mi>w</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo separator="true">,</mo><mi>k</mi><mo separator="true">,</mo><mi>l</mi><mo stretchy="false">)</mo></mrow></mrow></mfrac></mstyle></mrow><annotation encoding="application/x-tex">\Large I_{D}(i,j) = \frac{\sum_{k,l}{I(k,l)w(i,j,k,l)}}{\sum_{k,l}{w(i,j,k,l)}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.44em;vertical-align:-0.36em;"></span><span class="mord sizing reset-size6 size8"><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32453472222222224em;"><span style="top:-2.85em;margin-left:-0.07847em;margin-right:0.034722222222222224em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size8 size6 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">D</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen sizing reset-size6 size8">(</span><span class="mord mathnormal sizing reset-size6 size8">i</span><span class="mpunct sizing reset-size6 size8">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal sizing reset-size6 size8" style="margin-right:0.05724em;">j</span><span class="mclose sizing reset-size6 size8">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel sizing reset-size6 size8">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.5648359999999997em;vertical-align:-0.932618em;"></span><span class="mord sizing reset-size6 size8"><span class="mopen nulldelimiter sizing reset-size8 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1334847222222222em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size8 size6 mtight"><span class="mord mtight"><span class="mop mtight"><span class="mop op-symbol small-op mtight" style="position:relative;top:-0.0000050000000000050004em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.18639799999999984em;"><span style="top:-2.40029em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.43581800000000004em;"><span></span></span></span></span></span></span><span class="mspace mtight" style="margin-right:0.16666666666666666em;"></span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="mclose mtight">)</span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.612651388888889em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size8 size6 mtight"><span class="mord mtight"><span class="mop mtight"><span class="mop op-symbol small-op mtight" style="position:relative;top:-0.0000050000000000050004em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.18639799999999984em;"><span style="top:-2.40029em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.43581800000000004em;"><span></span></span></span></span></span></span><span class="mspace mtight" style="margin-right:0.16666666666666666em;"></span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07847em;">I</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="mclose mtight">)</span><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="mclose mtight">)</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.6476513888888888em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size8 size6"></span></span></span></span></span>

<p>其中</p>
<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathsize="1.44em"><mi>w</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo separator="true">,</mo><mi>k</mi><mo separator="true">,</mo><mi>l</mi><mo stretchy="false">)</mo><mo>=</mo><mi>exp</mi><mo>⁡</mo><mo stretchy="false">(</mo><mo>−</mo><mfrac><mrow><mo stretchy="false">(</mo><mi>i</mi><mo>−</mo><mi>k</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy="false">(</mo><mi>j</mi><mo>−</mo><mi>l</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><mrow><mn>2</mn><msubsup><mi>σ</mi><mi>d</mi><mn>2</mn></msubsup></mrow></mfrac><mo>−</mo><mfrac><mrow><mi mathvariant="normal">∥</mi><mi>f</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo><mo>−</mo><mi>f</mi><mo stretchy="false">(</mo><mi>k</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo><msup><mi mathvariant="normal">∥</mi><mn>2</mn></msup></mrow><mrow><mn>2</mn><msubsup><mi>σ</mi><mi>r</mi><mn>2</mn></msubsup></mrow></mfrac><mo stretchy="false">)</mo></mstyle></mrow><annotation encoding="application/x-tex">\Large w(i,j,k,l) = \exp(-\frac{(i-k)^2+(j-l)^2)}{2\sigma_{d}^2}-\frac{\|f(i,j)-f(k,j)\|^2}{2\sigma_{r}^2})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.44em;vertical-align:-0.36em;"></span><span class="mord mathnormal sizing reset-size6 size8" style="margin-right:0.02691em;">w</span><span class="mopen sizing reset-size6 size8">(</span><span class="mord mathnormal sizing reset-size6 size8">i</span><span class="mpunct sizing reset-size6 size8">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal sizing reset-size6 size8" style="margin-right:0.05724em;">j</span><span class="mpunct sizing reset-size6 size8">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal sizing reset-size6 size8" style="margin-right:0.03148em;">k</span><span class="mpunct sizing reset-size6 size8">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal sizing reset-size6 size8" style="margin-right:0.01968em;">l</span><span class="mclose sizing reset-size6 size8">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel sizing reset-size6 size8">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.334123999999999em;vertical-align:-0.8236159999999997em;"></span><span class="mop sizing reset-size6 size8">exp</span><span class="mopen sizing reset-size6 size8">(</span><span class="mord sizing reset-size6 size8">−</span><span class="mord sizing reset-size6 size8"><span class="mopen nulldelimiter sizing reset-size8 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0489638888888888em;"><span style="top:-2.6372861111111114em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size8 size6 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7959079999999998em;"><span style="top:-2.398692em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span></span></span></span><span style="top:-3.0448em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.30130799999999996em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.483611111111111em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size8 size6 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mbin mtight">−</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mclose mtight"><span class="mclose mtight">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mbin mtight">+</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mbin mtight">−</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="mclose mtight"><span class="mclose mtight">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.5719555555555553em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size8 size6"></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin sizing reset-size6 size8">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:2.2543079999999995em;vertical-align:-0.7437999999999999em;"></span><span class="mord sizing reset-size6 size8"><span class="mopen nulldelimiter sizing reset-size8 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0489638888888888em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size8 size6 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.4530000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.483611111111111em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size8 size6 mtight"><span class="mord mtight"><span class="mord mtight">∥</span><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mclose mtight">)</span><span class="mbin mtight">−</span><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mclose mtight">)</span><span class="mord mtight"><span class="mord mtight">∥</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.5165277777777777em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size8 size6"></span></span><span class="mclose sizing reset-size6 size8">)</span></span></span></span>

<p>根据指数函数的性质可得</p>
<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathsize="1.44em"><mi>w</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo separator="true">,</mo><mi>k</mi><mo separator="true">,</mo><mi>l</mi><mo stretchy="false">)</mo><mo>=</mo><mi>exp</mi><mo>⁡</mo><mo stretchy="false">(</mo><mo>−</mo><mfrac><mrow><mo stretchy="false">(</mo><mi>i</mi><mo>−</mo><mi>k</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy="false">(</mo><mi>j</mi><mo>−</mo><mi>l</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><mrow><mn>2</mn><msubsup><mi>σ</mi><mi>d</mi><mn>2</mn></msubsup></mrow></mfrac><mo stretchy="false">)</mo><mo>∗</mo><mi>exp</mi><mo>⁡</mo><mo stretchy="false">(</mo><mo>−</mo><mfrac><mrow><mi mathvariant="normal">∥</mi><mi>f</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo><mo>−</mo><mi>f</mi><mo stretchy="false">(</mo><mi>k</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo><msup><mi mathvariant="normal">∥</mi><mn>2</mn></msup></mrow><mrow><mn>2</mn><msubsup><mi>σ</mi><mi>r</mi><mn>2</mn></msubsup></mrow></mfrac><mo stretchy="false">)</mo></mstyle></mrow><annotation encoding="application/x-tex">\Large w(i,j,k,l) = \exp(-\frac{(i-k)^2+(j-l)^2)}{2\sigma_{d}^2})*\exp(-\frac{\|f(i,j)-f(k,j)\|^2}{2\sigma_{r}^2})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.44em;vertical-align:-0.36em;"></span><span class="mord mathnormal sizing reset-size6 size8" style="margin-right:0.02691em;">w</span><span class="mopen sizing reset-size6 size8">(</span><span class="mord mathnormal sizing reset-size6 size8">i</span><span class="mpunct sizing reset-size6 size8">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal sizing reset-size6 size8" style="margin-right:0.05724em;">j</span><span class="mpunct sizing reset-size6 size8">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal sizing reset-size6 size8" style="margin-right:0.03148em;">k</span><span class="mpunct sizing reset-size6 size8">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal sizing reset-size6 size8" style="margin-right:0.01968em;">l</span><span class="mclose sizing reset-size6 size8">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel sizing reset-size6 size8">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.334123999999999em;vertical-align:-0.8236159999999997em;"></span><span class="mop sizing reset-size6 size8">exp</span><span class="mopen sizing reset-size6 size8">(</span><span class="mord sizing reset-size6 size8">−</span><span class="mord sizing reset-size6 size8"><span class="mopen nulldelimiter sizing reset-size8 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0489638888888888em;"><span style="top:-2.6372861111111114em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size8 size6 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7959079999999998em;"><span style="top:-2.398692em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span></span></span></span><span style="top:-3.0448em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.30130799999999996em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.483611111111111em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size8 size6 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mbin mtight">−</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mclose mtight"><span class="mclose mtight">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mbin mtight">+</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mbin mtight">−</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="mclose mtight"><span class="mclose mtight">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.5719555555555553em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size8 size6"></span></span><span class="mclose sizing reset-size6 size8">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin sizing reset-size6 size8">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:2.2543079999999995em;vertical-align:-0.7437999999999999em;"></span><span class="mop sizing reset-size6 size8">exp</span><span class="mopen sizing reset-size6 size8">(</span><span class="mord sizing reset-size6 size8">−</span><span class="mord sizing reset-size6 size8"><span class="mopen nulldelimiter sizing reset-size8 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0489638888888888em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size8 size6 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.4530000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.483611111111111em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size8 size6 mtight"><span class="mord mtight"><span class="mord mtight">∥</span><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mclose mtight">)</span><span class="mbin mtight">−</span><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mclose mtight">)</span><span class="mord mtight"><span class="mord mtight">∥</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.5165277777777777em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size8 size6"></span></span><span class="mclose sizing reset-size6 size8">)</span></span></span></span>

<p>这里我们不严格按照双边滤波的定义来实现，稍作化简，其中函数G代表着一种滤波函数</p>
<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathsize="1.44em"><mi>w</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo separator="true">,</mo><mi>k</mi><mo separator="true">,</mo><mi>l</mi><mo stretchy="false">)</mo><mo>=</mo><mi>exp</mi><mo>⁡</mo><mo stretchy="false">(</mo><mo>−</mo><mfrac><mrow><mo stretchy="false">(</mo><mi>i</mi><mo>−</mo><mi>k</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy="false">(</mo><mi>j</mi><mo>−</mo><mi>l</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><mrow><mn>2</mn><msubsup><mi>σ</mi><mi>d</mi><mn>2</mn></msubsup></mrow></mfrac><mo stretchy="false">)</mo><mo>∗</mo><mi>G</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo separator="true">,</mo><mi>k</mi><mo separator="true">,</mo><mi>l</mi><mo stretchy="false">)</mo></mstyle></mrow><annotation encoding="application/x-tex">\Large w(i,j,k,l) = \exp(-\frac{(i-k)^2+(j-l)^2)}{2\sigma_{d}^2})*G(i,j,k,l)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.44em;vertical-align:-0.36em;"></span><span class="mord mathnormal sizing reset-size6 size8" style="margin-right:0.02691em;">w</span><span class="mopen sizing reset-size6 size8">(</span><span class="mord mathnormal sizing reset-size6 size8">i</span><span class="mpunct sizing reset-size6 size8">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal sizing reset-size6 size8" style="margin-right:0.05724em;">j</span><span class="mpunct sizing reset-size6 size8">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal sizing reset-size6 size8" style="margin-right:0.03148em;">k</span><span class="mpunct sizing reset-size6 size8">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal sizing reset-size6 size8" style="margin-right:0.01968em;">l</span><span class="mclose sizing reset-size6 size8">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel sizing reset-size6 size8">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.334123999999999em;vertical-align:-0.8236159999999997em;"></span><span class="mop sizing reset-size6 size8">exp</span><span class="mopen sizing reset-size6 size8">(</span><span class="mord sizing reset-size6 size8">−</span><span class="mord sizing reset-size6 size8"><span class="mopen nulldelimiter sizing reset-size8 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0489638888888888em;"><span style="top:-2.6372861111111114em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size8 size6 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7959079999999998em;"><span style="top:-2.398692em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span></span></span></span><span style="top:-3.0448em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.30130799999999996em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.483611111111111em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size8 size6 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mbin mtight">−</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mclose mtight"><span class="mclose mtight">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mbin mtight">+</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mbin mtight">−</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="mclose mtight"><span class="mclose mtight">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.5719555555555553em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size8 size6"></span></span><span class="mclose sizing reset-size6 size8">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin sizing reset-size6 size8">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.44em;vertical-align:-0.36em;"></span><span class="mord mathnormal sizing reset-size6 size8">G</span><span class="mopen sizing reset-size6 size8">(</span><span class="mord mathnormal sizing reset-size6 size8">i</span><span class="mpunct sizing reset-size6 size8">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal sizing reset-size6 size8" style="margin-right:0.05724em;">j</span><span class="mpunct sizing reset-size6 size8">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal sizing reset-size6 size8" style="margin-right:0.03148em;">k</span><span class="mpunct sizing reset-size6 size8">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal sizing reset-size6 size8" style="margin-right:0.01968em;">l</span><span class="mclose sizing reset-size6 size8">)</span></span></span></span>

<p>下面是Metal的Shader，实现了双边滤波公式，为了方便计算，滤波函数采用了均值模糊</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">kernel void BilateralFilter(texture2d&lt;float, access::read&gt; inTexture [[texture(0)]],</span><br><span class="line">                            texture2d&lt;float, access::write&gt; outTexture [[texture(1)]],</span><br><span class="line">                            device float *input [[buffer(0)]],</span><br><span class="line">                            uint2 gid [[thread_position_in_grid]])</span><br><span class="line">&#123;</span><br><span class="line">    const short radius &#x3D; input[0]; &#x2F;&#x2F; 卷积核半径</span><br><span class="line">    const float boxBlur &#x3D; 1.0 &#x2F; (2 * radius + 1) &#x2F; (2 * radius + 1); &#x2F;&#x2F; 均值模糊(函数G)</span><br><span class="line">    const float sigma &#x3D; 0.3; &#x2F;&#x2F; sigma(σ)</span><br><span class="line">    const float coe &#x3D; -0.5 &#x2F; pow(sigma, 2);</span><br><span class="line">    </span><br><span class="line">    float weightSum &#x3D; 0;</span><br><span class="line">    float3 colorSum &#x3D; float3(0, 0, 0);</span><br><span class="line">    const float4 colorAtCenter &#x3D; inTexture.read(gid); &#x2F;&#x2F; 卷积核中心点颜色(RGBA)</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; 对卷积核内的所有像素进行处理并累加</span><br><span class="line">    for (short x &#x3D; -radius; x &lt;&#x3D; radius; x++) &#123;</span><br><span class="line">        for (short y &#x3D; -radius; y &lt;&#x3D; radius; y++) &#123;</span><br><span class="line">            ushort2 pixel &#x3D; ushort2(gid.x + x, gid.y + y);</span><br><span class="line">            float4 colorAtPixel &#x3D; inTexture.read(pixel);</span><br><span class="line">            float closeness &#x3D; exp(pow(distance(colorAtPixel.xyz, colorAtCenter.xyz), 2) * coe);</span><br><span class="line">            float weight &#x3D; closeness * boxBlur;</span><br><span class="line">            colorSum +&#x3D; colorAtPixel.rgb * weight;</span><br><span class="line">            weightSum +&#x3D; weight;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    outTexture.write(float4((colorSum &#x2F; weightSum), 1), gid);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>另一种加权实现，速度更快，但实际效果略差</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">float closeness &#x3D; 1 - distance(colorAtPixel.xyz, colorAtCenter.xyz) &#x2F; length(float3(1,1,1));</span><br></pre></td></tr></table></figure>

<p>下图为结果  <br>第一行为均值滤波处理<br>第二行为双边滤波处理  <br>从左至右分别为原图，以及卷积核半径等于5、9、13、17的图  </p>
<p>可以看到，第一行图片里，整张图都变得模糊起来，而在第二行的图片中，边缘细节得到了一定程度上的保留<br>因此，双边滤波可以应用在美颜领域上，配合机器学习，检测人的皮肤区域并对其进行处理，就可以达到磨皮祛斑的美颜效果</p>
<p>可以下载图片查看原图</p>
<img src="/images/2020/bilateralFilter/Beauty.jpg">


        

        
            <div class="tags">
                <a class="tag-none-link" href="/tags/Metal/" rel="tag">Metal</a><a class="tag-none-link" href="/tags/%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86/" rel="tag">图像处理</a>
            </div>
        

    </section>
</article>
  
</section>



        <script>setLoadingBarProgress(60);</script>
    </main>

    <footer id="footer" class="clearfix">

    

    <div class="social-wrapper">
        
            
                <a href="https://github.com/artchen" class="social github"
                   target="_blank" rel="external">
                    <span class="icon icon-github"></span>
                </a>
            
                <a href="/atom.xml" class="social rss"
                   target="_blank" rel="external">
                    <span class="icon icon-rss"></span>
                </a>
            
        
    </div>

    <div class="theme-by">Theme <span class="codename">Memory</span> designed by <a href="https://artifact.me/"
                                                                                    target="_blank">Art Chen</a>.
    </div>
    <div>&copy; <a href="/">Hexo</a></div>

</footer>


    <script>setLoadingBarProgress(80);</script>
    <div class="overlay"></div>
</div>

<div class="site-sidebar" id="site-sidebar">

    

    <div class="sidebar-switch clearfix "
         style="display: none">
        <a class="dark-btn active" data-toggle="toc">
            <span class="icon icon-list"></span>
            <span class="text">Index</span>
        </a>
        <a class="dark-btn" data-toggle="bio">
            <span class="icon icon-person"></span>
            <span class="text">Bio</span>
        </a>
    </div>

    <div class="site-toc "
         style="display: none">
        
            <div class="no-index">No Index</div>
        
    </div>

    <div class="site-bio show"
         style="display: block">

        <div class="about-me clearfix">
            <div class="avatar">
                <img src="/img/avatar.jpg"/>
            </div>
            <div class="info">
                <a class="name dark-btn" href="/about">
                    Theresa
                </a>
            </div>
            <div class="info">
                <span class="item desc">
                    
                </span>
            </div>
        </div>

        <div class="menu section">
            <ul class="clearfix">
                
                    <li class="left">
                        <a href="/about"
                           onfocus="this.blur();"
                           class="nav-about dark-btn block">
                            About
                        </a>
                    </li>
                
                    <li class="right">
                        <a href="/archives"
                           onfocus="this.blur();"
                           class="nav-archives dark-btn block">
                            Archives
                        </a>
                    </li>
                
            </ul>
        </div>

    </div>

    <div class="shortcuts">
        <a href="#header" class="top window-nav dark-btn" id="go-top">
            <span class="icon icon-chevron-thin-up"></span>
        </a>
        <a class="close dark-btn" id="sidebar-close">
            <span class="icon icon-close"></span>
        </a>
        <a href="#footer" class="top window-nav dark-btn" id="go-bottom">
            <span class="icon icon-chevron-thin-down"></span>
        </a>
    </div>

</div>





<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script>window.jQuery || document.write('<script src="/js/jquery.min.js"><\/script>')</script>


<script src="/js/jquery.fitvids.js"></script>

<script>
  var GOOGLE_CUSTOM_SEARCH_API_KEY = "";
  var GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "";
  var ALGOLIA_API_KEY = "";
  var ALGOLIA_APP_ID = "";
  var ALGOLIA_INDEX_NAME = "";
  var AZURE_SERVICE_NAME = "";
  var AZURE_INDEX_NAME = "";
  var AZURE_QUERY_KEY = "";
  var SEARCH_SERVICE = "";
  var universalSearchConfig = {};
  if (SEARCH_SERVICE === 'google') {
    universalSearchConfig = {
      searchService: SEARCH_SERVICE,
      apiKey: GOOGLE_CUSTOM_SEARCH_API_KEY,
      engineId: GOOGLE_CUSTOM_SEARCH_ENGINE_ID,
      imagePath: "/img/"
    };
  } else if (SEARCH_SERVICE === 'algolia') {
    universalSearchConfig = {
      searchService: SEARCH_SERVICE,
      apiKey: ALGOLIA_API_KEY,
      appId: ALGOLIA_APP_ID,
      indexName: ALGOLIA_INDEX_NAME,
      imagePath: "/img/"
    };
  } else if (SEARCH_SERVICE === 'azure') {
    universalSearchConfig = {
      searchService: SEARCH_SERVICE,
      serviceName: AZURE_SERVICE_NAME,
      indexName: AZURE_INDEX_NAME,
      apiKey: AZURE_QUERY_KEY,
      imagePath: "/img/"
    };
  }
</script>

<script src="/js/app.js"></script>


<script src="/js/search.js"></script>





<script>setLoadingBarProgress(100);</script>

</body>
</html>
